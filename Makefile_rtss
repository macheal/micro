NAME=micro
#IMAGE_NAME=micro/$(NAME)
IMAGE_NAME=hub.smartsteps.com/rtss/micro.rtss_config
IMAGE_NAME=hub.smartsteps.com/rtss/macheal/$(NAME)
#IMAGE_NAME=rtssregistry:33333/rtss/macheal/$(NAME)
GIT_COMMIT=$(shell git rev-parse --short HEAD)
GIT_TAG=$(shell git describe --abbrev=0 --tags --always --match "v*")
GIT_IMPORT=github.com/micro/micro/v2/cmd
CGO_ENABLED=0
BUILD_DATE=$(shell date +%s)
LDFLAGS=-X $(GIT_IMPORT).GitCommit=$(GIT_COMMIT) -X $(GIT_IMPORT).GitTag=$(GIT_TAG) -X $(GIT_IMPORT).BuildDate=$(BUILD_DATE)
CROSS-LINUX=CGO_ENABLED=0 GOOS=linux GOARCH=amd64

IMAGE_TAG=$(GIT_TAG)-$(GIT_COMMIT)


all: build

vendor:
	go mod vendor

build:
	$(CROSS-LINUX) go build  -a -installsuffix cgo -ldflags "-s -w ${LDFLAGS}" -o $(NAME)

docker:
	docker build -f Dockerfile_rtss -t $(IMAGE_NAME):$(IMAGE_TAG)_$(BUILD_DATE) .
	docker tag $(IMAGE_NAME):$(IMAGE_TAG)_$(BUILD_DATE) $(IMAGE_NAME):latest
	docker push $(IMAGE_NAME):$(IMAGE_TAG)_$(BUILD_DATE)
	docker push $(IMAGE_NAME):latest
	docker build -f Dockerfile_rtss -t $(IMAGE_NAME):$(IMAGE_TAG) .
	docker tag $(IMAGE_NAME):$(IMAGE_TAG) $(IMAGE_NAME):latest
	docker push $(IMAGE_NAME):$(IMAGE_TAG)
	#docker push $(IMAGE_NAME):latest

vet:
	go vet ./...

test: vet
	go test -v ./...

clean:
	rm -rf ./micro

.PHONY: build clean vet test docker
